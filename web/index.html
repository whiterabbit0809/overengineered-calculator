<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Over-engineered Calculator</title>
</head>
<body>
  <h1>Over-engineered Calculator</h1>

  <!-- AUTH SECTION -->
  <section>
    <h2>Sign up</h2>
    <form id="signup-form">
      <input type="email" id="signup-email" placeholder="Email" required />
      <input type="password" id="signup-password" placeholder="Password" required />
      <button type="submit">Sign up</button>
    </form>
    <div id="signup-result"></div>
  </section>

  <section>
    <h2>Login</h2>
    <form id="login-form">
      <input type="email" id="login-email" placeholder="Email" required />
      <input type="password" id="login-password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
    <div id="login-result"></div>
  </section>

  <!-- CALCULATOR + HISTORY (only shown when logged in) -->
  <section id="calc-section" style="display:none; margin-top:2rem;">
    <h2>Calculator</h2>

    <form id="calc-form">
      <label>
        Current result:
        <input type="number" id="current-result" value="0" readonly />
      </label>

      <label>
        Operation:
        <select id="calc-op">
          <option value="ADD">+</option>
          <option value="SUBTRACT">-</option>
          <option value="MULTIPLY">*</option>
          <option value="DIVIDE">/</option>
        </select>
      </label>

      <label>
        Number:
        <input type="number" id="calc-num" step="any" required />
      </label>

      <button type="submit">Calculate</button>

      <label style="margin-left:1rem;">
        Result:
        <input type="number" id="new-result" readonly />
      </label>
    </form>

    <div id="calc-message" style="margin-top:0.5rem;"></div>

    <h3 style="margin-top:2rem;">History</h3>
    <button id="history-button">Load history</button>
    <pre id="history-result" style="background:#f5f5f5; padding:0.5rem; max-height:300px; overflow:auto;"></pre>
  </section>

<script>
  const baseUrl = '/api/v1';

  // --- SIGNUP ---
  document.getElementById('signup-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('signup-email').value;
    const password = document.getElementById('signup-password').value;

    const res = await fetch(`${baseUrl}/auth/signup`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    });

    let text = 'Sign up failed';
    try {
      const data = await res.json();
      if (data.status === 'ok') {
        text = 'Sign up: ok';
      } else {
        text = `Sign up: failed (${data.message || 'unknown error'})`;
      }
    } catch (err) {
      text = `Sign up: HTTP ${res.status}`;
    }

    document.getElementById('signup-result').innerText = text;
  });

  // --- LOGIN ---
  document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;

    const res = await fetch(`${baseUrl}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    });

    let text = 'Login failed';
    try {
      const data = await res.json();
      text = `Login: ${data.status}`;

      if (data.status === 'passed' && data.token) {
        // Cache the token and show calc section
        localStorage.setItem('authToken', data.token);
        document.getElementById('calc-section').style.display = 'block';

        // Reset calc UI, then load history and set current result from latest entry
        resetCalcUI();
        await loadHistory(); // this will also update currentResult
      }
    } catch (err) {
      text = `Login: HTTP ${res.status}`;
    }

    document.getElementById('login-result').innerText = text;
  });

  // --- CALCULATOR ---
  let currentResult = 0;

  function getToken() {
    return localStorage.getItem('authToken');
  }

  const currentResultInput = document.getElementById('current-result');
  const newResultInput = document.getElementById('new-result');
  const calcMessageDiv = document.getElementById('calc-message');

  function resetCalcUI() {
    currentResult = 0;
    currentResultInput.value = 0;
    newResultInput.value = '';
    document.getElementById('calc-num').value = '';
    document.getElementById('history-result').innerText = '';
    calcMessageDiv.innerText = '';
  }

  document.getElementById('calc-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    calcMessageDiv.innerText = '';

    const token = getToken();
    if (!token) {
      calcMessageDiv.innerText = 'Please login first.';
      return;
    }

    const num = parseFloat(document.getElementById('calc-num').value);
    const operation = document.getElementById('calc-op').value;

    if (Number.isNaN(num)) {
      calcMessageDiv.innerText = 'Please enter a valid number.';
      return;
    }

    const res = await fetch(`${baseUrl}/calc`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
      },
      body: JSON.stringify({ num, operation }),
    });

    try {
      const data = await res.json();
      if (res.ok) {
        currentResult = data.result;
        currentResultInput.value = currentResult;
        newResultInput.value = data.result;
        calcMessageDiv.innerText = `OK: ${data.expression} = ${data.result}`;
        // Optionally auto-refresh history
        await loadHistory();
      } else {
        calcMessageDiv.innerText = `Error: ${data.error || 'unknown error'}`;
      }
    } catch (err) {
      calcMessageDiv.innerText = `Error: HTTP ${res.status}`;
    }
  });

  // --- HISTORY ---
  async function loadHistory() {
    const token = getToken();
    const historyResult = document.getElementById('history-result');

    if (!token) {
      historyResult.innerText = 'Please login first.';
      return;
    }

    const res = await fetch(`${baseUrl}/history?limit=20&offset=0`, {
      headers: {
        'Authorization': `Bearer ${token}`,
      },
    });

    try {
      const data = await res.json();
      if (res.ok) {
        // Show raw history JSON
        historyResult.innerText = JSON.stringify(data, null, 2);

        // If there is history, set currentResult to the latest entry's result
        if (Array.isArray(data) && data.length > 0 && typeof data[0].result === 'number') {
          currentResult = data[0].result;
          currentResultInput.value = currentResult;
          newResultInput.value = currentResult;
        } else {
          // No history yet â†’ start from 0
          currentResult = 0;
          currentResultInput.value = 0;
          newResultInput.value = '';
        }
      } else {
        historyResult.innerText = `Error: ${data.error || 'unknown error'}`;
      }
    } catch (err) {
      historyResult.innerText = `Error: HTTP ${res.status}`;
    }
  }

  document.getElementById('history-button').addEventListener('click', loadHistory);

  // --- On load: if we already have a token, show calculator and restore state from history ---
  if (getToken()) {
    document.getElementById('calc-section').style.display = 'block';
    resetCalcUI();
    loadHistory(); // no await needed here
  }
</script>
</body>
</html>
