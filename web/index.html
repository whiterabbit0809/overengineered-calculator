<script>
  const baseUrl = '/api/v1';

  // --- SIGNUP ---
  document.getElementById('signup-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('signup-email').value;
    const password = document.getElementById('signup-password').value;

    const res = await fetch(`${baseUrl}/auth/signup`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    });

    let text = 'Sign up failed';
    try {
      const data = await res.json();
      if (data.status === 'ok') {
        text = 'Sign up: ok';
      } else {
        text = `Sign up: failed (${data.message || 'unknown error'})`;
      }
    } catch (err) {
      text = `Sign up: HTTP ${res.status}`;
    }

    document.getElementById('signup-result').innerText = text;
  });

  // --- LOGIN ---
  document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;

    const res = await fetch(`${baseUrl}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    });

    let text = 'Login failed';
    try {
      const data = await res.json();
      text = `Login: ${data.status}`;

      if (data.status === 'passed' && data.token) {
        // Cache the token and show calc section
        localStorage.setItem('authToken', data.token);
        document.getElementById('calc-section').style.display = 'block';

        // Reset calc UI, then load history and set current result from latest entry
        resetCalcUI();
        await loadHistory(); // this will also update currentResult
      }
    } catch (err) {
      text = `Login: HTTP ${res.status}`;
    }

    document.getElementById('login-result').innerText = text;
  });

  // --- CALCULATOR ---
  let currentResult = 0;

  function getToken() {
    return localStorage.getItem('authToken');
  }

  const currentResultInput = document.getElementById('current-result');
  const newResultInput = document.getElementById('new-result');
  const calcMessageDiv = document.getElementById('calc-message');

  function resetCalcUI() {
    currentResult = 0;
    currentResultInput.value = 0;
    newResultInput.value = '';
    document.getElementById('calc-num').value = '';
    document.getElementById('history-result').innerText = '';
    calcMessageDiv.innerText = '';
  }

  document.getElementById('calc-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    calcMessageDiv.innerText = '';

    const token = getToken();
    if (!token) {
      calcMessageDiv.innerText = 'Please login first.';
      return;
    }

    const num = parseFloat(document.getElementById('calc-num').value);
    const operation = document.getElementById('calc-op').value;

    if (Number.isNaN(num)) {
      calcMessageDiv.innerText = 'Please enter a valid number.';
      return;
    }

    const res = await fetch(`${baseUrl}/calc`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
      },
      body: JSON.stringify({ num, operation }),
    });

    try {
      const data = await res.json();
      if (res.ok) {
        currentResult = data.result;
        currentResultInput.value = currentResult;
        newResultInput.value = data.result;
        calcMessageDiv.innerText = `OK: ${data.expression} = ${data.result}`;
        // Optionally auto-refresh history
        await loadHistory();
      } else {
        calcMessageDiv.innerText = `Error: ${data.error || 'unknown error'}`;
      }
    } catch (err) {
      calcMessageDiv.innerText = `Error: HTTP ${res.status}`;
    }
  });

  // --- HISTORY ---
  async function loadHistory() {
    const token = getToken();
    const historyResult = document.getElementById('history-result');

    if (!token) {
      historyResult.innerText = 'Please login first.';
      return;
    }

    const res = await fetch(`${baseUrl}/history?limit=20&offset=0`, {
      headers: {
        'Authorization': `Bearer ${token}`,
      },
    });

    try {
      const data = await res.json();
      if (res.ok) {
        // Show raw history JSON
        historyResult.innerText = JSON.stringify(data, null, 2);

        // If there is history, set currentResult to the latest entry's result
        if (Array.isArray(data) && data.length > 0 && typeof data[0].result === 'number') {
          currentResult = data[0].result;
          currentResultInput.value = currentResult;
          newResultInput.value = currentResult;
        } else {
          // No history yet â†’ start from 0
          currentResult = 0;
          currentResultInput.value = 0;
          newResultInput.value = '';
        }
      } else {
        historyResult.innerText = `Error: ${data.error || 'unknown error'}`;
      }
    } catch (err) {
      historyResult.innerText = `Error: HTTP ${res.status}`;
    }
  }

  document.getElementById('history-button').addEventListener('click', loadHistory);

  // --- On load: if we already have a token, show calculator and restore state from history ---
  if (getToken()) {
    document.getElementById('calc-section').style.display = 'block';
    resetCalcUI();
    loadHistory(); // no await needed here
  }
</script>